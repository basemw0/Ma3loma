import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import {
  SignupWrapper,
  SignupCard,
  RoundedInput,
  OrangeButton,
  Title,
  SubText,
  GoogleButton,
  SkipButton,
  ToastNotification,
} from "./Signup.styles";


import WarningAmberIcon from '@mui/icons-material/WarningAmber';
import CloseIcon from "@mui/icons-material/Close";
import { Fade, InputAdornment, Box, Typography } from "@mui/material"; // <-- added Box, Typography
import CheckCircleIcon from "@mui/icons-material/CheckCircle";
import searchIcon from "./search.png"; // <-- added
import api from "../../src/api/axios";
export default function Signup() {
  const navigate = useNavigate();
  const [step, setStep] = useState(1);

  const [email, setEmail] = useState("");
  const [verifyCode, setVerifyCode] = useState("");
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");

  // 1. Add Toast State
  const [showToast, setShowToast] = useState(false);

    const [touched, setTouched] = useState({
  email: false,
  code: false,
  username: false,
  password: false,
});





  const isEmailValid = email.includes("@");
  const isUsernameAvailable = username.length >= 4;

  // Auto-dismiss toast after 5 seconds
    useEffect(() => {
      let timer;
      if (showToast) {
        timer = setTimeout(() => {
          setShowToast(false);
        }, 5000);
      }
      return () => clearTimeout(timer);
    }, [showToast]);

  // 3. Add Handler for the "Resend" click
  const handleResend = () => {
    setShowToast(false); // Reset to allow animation replay
    setTimeout(() => setShowToast(true), 100);
    console.log("Resending code to:", email);
  };

  const getBorderColor = (value, touched) => {
  if (!touched) return "#ccc";
  return value ? "green" : "red";
  
};

const continueWithGoogle = () => {
    window.location.href = "/auth/google";
    // or use your base URL
    // window.location.href = `${process.env.REACT_APP_API_BASE_URL || 'http://localhost:5000'}/auth/google`;
  };

  const GoogleIcon = () => (
    <img
      src={searchIcon}
      alt="Google"
      style={{ width: 18, height: 18 }}
    />
  );
const handleSignup = async () => {
    try {
      const response = await api.post("/api/users/signup", {
        email: email,
        username: username, // Send 'username' specifically
        password: password,
        image: "https://www.redditstatic.com/avatars/avatar_default_02_FF4500.png"
      });

      console.log("Signup Success:", response.data);
      
      // If your backend sends the token on signup (which it does in your code):
      if (response.data.user?.token) {
        localStorage.setItem("token", response.data.user.token);
        // Redirect to home page
        window.location.href = "/"; 
      }
    } catch (error) {
      console.error("Signup failed:", error.response?.data);
      alert(error.response?.data?.message || "Signup failed");
    }
  };
  return (
    <SignupWrapper>
      <SignupCard elevation={3}>
        {/* STEP 1 — EMAIL INPUT */}
        {step === 1 && (
          <Fade in={true}>
            <div>
              <Title variant="h5">Sign Up</Title>

              <RoundedInput
                  label={
                    <span>
                      Email <span style={{ color: "red" }}>*</span>
                    </span>
                  }
                  variant="outlined"
                  fullWidth
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  onBlur={() => setTouched({ ...touched, email: true })}
                  InputProps={{
                    endAdornment: (
                      <InputAdornment position="end">
                        <Fade in={Boolean(email)}>
                          <span>
                          <CheckCircleIcon sx={{ color: "#FF4500" }} />
                          </span>
                        </Fade>
                      </InputAdornment>
                    ),
                  }}
                  sx={{
                    "& .MuiOutlinedInput-root": {
                      borderRadius: "25px",
                      "& fieldset": {
                        borderColor: getBorderColor(email, touched.email),
                      },
                      "&:hover fieldset": {
                        borderColor: getBorderColor(email, touched.email),
                      },
                      "&.Mui-focused fieldset": {
                        borderColor: getBorderColor(email, touched.email),
                      },
                    },
                  }}
                />


              <SubText style={{fontSize: "15px"}}>
                Already a redditor?{" "}
                <a href="/login" 
                style={{ 
                        color: "#5495ff", 
                        textDecoration: "none", 
                        fontSize: "15px",
                        fontWeight: "bold" 
                      }}>

                  Log In
                </a>
              </SubText>

            <OrangeButton
                fullWidth
                disabled={!isEmailValid}
                sx={{ backgroundColor: !isEmailValid ? "#ddd" : "#FF4500" }}
                onClick={() => {
                  setStep(2);
                  setShowToast(true); // Show toast on moving to step 2
                }}
              >
                Continue
            </OrangeButton>

              {/* OR divider */}
              <Box sx={{ display: "flex", alignItems: "center", my: 2 }}>
                <Box sx={{ flex: 1, height: 1, background: "#e0e0e0" }} />
                <Typography sx={{ mx: 2, fontSize: 12, color: "#6b6b6b" }}>or</Typography>
                <Box sx={{ flex: 1, height: 1, background: "#e0e0e0" }} />
              </Box>

              {/* Continue with Google */}
              <GoogleButton variant="outlined" fullWidth startIcon={<GoogleIcon />} onClick={continueWithGoogle}>
                Continue with Google
              </GoogleButton>
            </div>
          </Fade>
        )}

        {/* STEP 2 — EMAIL VERIFICATION */}
          {step === 2 && (
            <Fade in={true}>
              <div>
                <Title variant="h5">Verify your email</Title>

               <p
                style={{
                  fontSize: "16px",
                  textAlign: "center",
                  color: "#1a1a1b", // Reddit's dark text color
                  lineHeight: "21px",
                  margin: "8px 0 24px 0", // Matches 'my-xs' spacing
                }}
              >
                 Enter the 6-digit code we sent to <br />
                  {email}
              </p>

                <RoundedInput
                  label="Verification Code"
                  variant="outlined"
                  fullWidth
                  value={verifyCode}
                  onChange={(e) => {
                    const value = e.target.value;
                    if (/^\d*$/.test(value)) setVerifyCode(value);
                  }}
                  inputProps={{ maxLength: 6 }}
                  onBlur={() => setTouched({ ...touched, code: true })}
                  InputProps={{
                    endAdornment: (
                      <InputAdornment position="end">
                        <Fade in={verifyCode.length === 6}>
                          <span>
                            <CheckCircleIcon sx={{ color: "#ff4500" }} />
                          </span>
                        </Fade>
                      </InputAdornment>
                    ),
                  }}
                  sx={{
                    "& .MuiOutlinedInput-root": {
                      borderRadius: "25px",
                      "& fieldset": {
                        borderColor: getBorderColor(verifyCode.length === 6, touched.code),
                      },
                      "&:hover fieldset": {
                        borderColor: getBorderColor(verifyCode.length === 6, touched.code),
                      },
                      "&.Mui-focused fieldset": {
                        borderColor: getBorderColor(verifyCode.length === 6, touched.code),
                      },
                    },
                  }}
                />

              <p style={{ fontSize: "14px", color: "#1a1a1b", textAlign: "center", marginBottom: "20px" }}>
                  Didn't get an email?{' '}
                  <span 
                    onClick={handleResend}
                    style={{ 
                      color: "#0079d3", 
                      fontWeight: "bold", 
                      cursor: "pointer",
                      textDecoration: "none" 
                    }}
                  >
                    Resend
                  </span>
              </p>

              
                  <SkipButton onClick={() => setStep(3)}>Skip</SkipButton>
                

                <OrangeButton
                  fullWidth
                  disabled={verifyCode.length !== 6}
                  sx={{
                    backgroundColor: verifyCode.length !== 6 ? "#ddd" : "#FF4500",
                  }}
                  onClick={() => setStep(3)}
                >
                  Continue
                </OrangeButton>
              </div>
            </Fade>
          )}


        

        {/* STEP 3 — USERNAME + PASSWORD */}
        {step === 3 && (
          <Fade in={true}>
            <div>
              <Title variant="h6">Create your username and password</Title>

              <p
                style={{
                  fontSize: "14px",
                  color: "#444",
                  marginBottom: "16px",
                }}
              >
                Reddit is anonymous, so your username is what you’ll go by here.
                Choose wisely—because once you get a name, you can’t change it.
              </p>

              {/* USERNAME */}
              <RoundedInput
                  label={
                    <span>
                      Username <span style={{ color: "red" }}>*</span>
                    </span>
                  }
                  variant="outlined"
                  fullWidth
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  onBlur={() => setTouched({ ...touched, username: true })}
                  InputProps={{
                    endAdornment: (
                      <InputAdornment position="end">
                        <Fade in={Boolean(username)}>
                          <span>
                          <CheckCircleIcon sx={{ color: "green" }} />
                          </span>
                        </Fade>
                      </InputAdornment>
                    ),
                  }}
                  sx={{
                    "& .MuiOutlinedInput-root": {
                      borderRadius: "25px",
                      "& fieldset": {
                        borderColor: getBorderColor(username, touched.username),
                      },
                      "&:hover fieldset": {
                        borderColor: getBorderColor(username, touched.username),
                      },
                      "&.Mui-focused fieldset": {
                        borderColor: getBorderColor(username, touched.username),
                      },
                    },
                  }}
                />


              {username.length > 0 && (
                <p style={{ color: "green", marginTop: "-12px" }}>
                  Nice! Username available
                </p>
              )}

              {/* PASSWORD */}
              <RoundedInput
                  label={
                    <span>
                      Password <span style={{ color: "red" }}>*</span>
                    </span>
                  }
                  type="password"
                  variant="outlined"
                  fullWidth
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  onBlur={() => setTouched({ ...touched, password: true })}
                  InputProps={{
                    endAdornment: (
                      <InputAdornment position="end">
                        <Fade in={password.length >= 8}>
                          <span>
                          <CheckCircleIcon sx={{ color: "green" }} />
                          </span>
                        </Fade>
                      </InputAdornment>
                    ),
                  }}
                  sx={{
                    "& .MuiOutlinedInput-root": {
                      borderRadius: "25px",
                      "& fieldset": {
                        borderColor: getBorderColor(password.length >= 8, touched.password),
                      },
                      "&:hover fieldset": {
                        borderColor: getBorderColor(password.length >= 8, touched.password),
                      },
                      "&.Mui-focused fieldset": {
                        borderColor: getBorderColor(password.length >= 8, touched.password),
                      },
                    },
                  }}
                />

              {/* ERROR MESSAGE */}
              {touched.password && password.length > 0 && password.length < 8 && (
                <p style={{ color: "red", marginTop: "-12px" }}>
                  Please lengthen this text to 8 characters or more (you are currently using {password.length} characters).
                </p>
              )}



              <OrangeButton
                fullWidth
                disabled={!username || !password}
                onClick={handleSignup}  // <--- ATTACH THE HANDLER HERE
                sx={{
                  backgroundColor: !username || !password ? "#ddd" : "#FF4500",
                }}
              >
                Sign Up
              </OrangeButton>

              
            </div>
          </Fade>
        )}
      </SignupCard>

      {/* Toast Notification */}
        <Fade in={step === 2 && showToast}>
          <ToastNotification>
              <WarningAmberIcon sx={{ color: "#fff" }} />
              <span>Email sent to {email}</span>
              <CloseIcon 
                  sx={{ cursor: "pointer", marginLeft: "10px", fontSize: "18px" }} 
                  onClick={() => setShowToast(false)} 
              />
          </ToastNotification>
        </Fade>
    </SignupWrapper>
  );
}
